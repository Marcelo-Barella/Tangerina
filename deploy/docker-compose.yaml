version: '3.8'

services:
  tangerina-bot:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: tangerina-bot
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - WHISPER_API_URL=${WHISPER_API_URL:-http://whisper-asr:5002}
    ports:
      - "5000:5000"
    volumes:
      - ../tangerina_persona.txt:/app/tangerina_persona.txt:ro
      - ../logs:/app/logs
      - ../.cursor:/app/.cursor
      - chromadb_data:/app/data/chromadb
    networks:
      - tangerina-network
    dns: # DNS resolvers to use for the container ( Disoord trolled me so I added this)
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  piper-tts:
    build:
      context: ./piper
      dockerfile: Dockerfile
    container_name: tangerina-piper-tts
    restart: unless-stopped
    environment:
      - PIPER_BIN=/usr/local/bin/piper
      - PIPER_MODEL_PATH=${PIPER_MODEL_PATH:-/app/models/pt_BR-faber-medium.onnx}
      - ESPEAK_DATA=/usr/local/share/piper/espeak-ng-data
    ports:
      - "5001:5001"
    volumes:
      - piper_models:/app/models
    networks:
      - tangerina-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  n8n:
    image: n8nio/n8n:latest
    container_name: tangerina-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-changeme}
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - tangerina-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - n8n

  chromadb-viz:
    build:
      context: ./chromadb-viz
      dockerfile: Dockerfile
    container_name: tangerina-chromadb-viz
    restart: unless-stopped
    ports:
      - "8501:8501"
    volumes:
      - chromadb_data:/data/chromadb
    networks:
      - tangerina-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  tangerina-test:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: tangerina-test
    environment:
      - PYTHONPATH=/app
      - DISCORD_TOKEN=test_token_not_used
      - ZHIPUAI_API_KEY=test_key_not_used
    volumes:
      - ../tests:/app/tests
      - ../htmlcov:/app/htmlcov
    networks:
      - tangerina-network
    command: >
      pytest tests/
      -v
      --cov=chatbot
      --cov=features
      --cov=flask_routes
      --cov-report=term
      --cov-report=html
      --cov-report=xml
      --cov-fail-under=70
    profiles:
      - test

  tangerina-test-unit:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: tangerina-test-unit
    environment:
      - PYTHONPATH=/app
    volumes:
      - ../tests:/app/tests
    networks:
      - tangerina-network
    command: pytest tests/unit/ -v -m unit
    profiles:
      - test-unit

  tangerina-test-integration:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: tangerina-test-integration
    environment:
      - PYTHONPATH=/app
      - DISCORD_TOKEN=test_token_not_used
      - ZHIPUAI_API_KEY=test_key_not_used
    volumes:
      - ../tests:/app/tests
    networks:
      - tangerina-network
    command: pytest tests/integration/ -v -m integration
    profiles:
      - test-integration

  tangerina-test-watch:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: tangerina-test-watch
    environment:
      - PYTHONPATH=/app
    volumes:
      - ../tests:/app/tests
      - ../chatbot:/app/chatbot
      - ../features:/app/features
      - ../flask_routes.py:/app/flask_routes.py
    networks:
      - tangerina-network
    command: pytest tests/ -v --cov=chatbot --cov=features --cov=flask_routes -f
    profiles:
      - test-watch

networks:
  tangerina-network:
    driver: bridge
    name: tangerina-network

volumes:
  n8n_data:
    name: tangerina-n8n-data
  piper_models:
    name: tangerina-piper-models
  chromadb_data:
    name: tangerina-chromadb-data

